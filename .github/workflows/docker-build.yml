name: Docker Build & Health Check

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t meme-generator:ci .

      - name: Run container (detached)
        run: |
          docker run -d --name meme-ci -p 5000:5000 meme-generator:ci

      - name: Health check (wait for http://localhost:5000/)
        run: |
          set -e
          echo "Waiting for service to respond on http://localhost:5000/ ..."
          for i in $(seq 1 30); do
            if curl -sSf http://localhost:5000/ >/dev/null; then
              echo "Service is up after $i attempts"
              exit 0
            fi
            echo "Attempt $i failed; sleeping 2s"
            sleep 2
          done
          echo "Service did not become ready in time. Dumping logs:" >&2
          docker logs meme-ci || true
          exit 1

      - name: Cleanup container
        if: always()
        run: |
          docker rm -f meme-ci || true
